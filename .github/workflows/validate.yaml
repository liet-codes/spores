name: Validate Registration

on:
  pull_request:
    paths:
      - 'registered.txt'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check additions only from owner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "PR author: $PR_AUTHOR"
          
          # Get added lines (new registrations)
          ADDED=$(git diff origin/main -- registered.txt | grep '^+' | grep -v '^+++' | grep -v '^#' | sed 's/^+//')
          
          if [ -z "$ADDED" ]; then
            echo "No new registrations"
            exit 0
          fi
          
          echo "New registrations:"
          echo "$ADDED"
          echo ""
          
          # Check each added repo
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            
            OWNER=$(echo "$line" | cut -d'/' -f1)
            REPO=$(echo "$line" | cut -d'/' -f2)
            
            echo "Checking $OWNER/$REPO..."
            
            # Verify PR author matches owner
            if [ "$PR_AUTHOR" != "$OWNER" ]; then
              echo "❌ PR author ($PR_AUTHOR) doesn't match repo owner ($OWNER)"
              echo "   You can only register your own repos."
              exit 1
            fi
            echo "  ✓ Owner matches"
            
            # Verify repo exists
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$OWNER/$REPO")
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "❌ Repo $OWNER/$REPO not found (HTTP $HTTP_CODE)"
              exit 1
            fi
            echo "  ✓ Repo exists"
            
          done <<< "$ADDED"
          
          echo ""
          echo "✅ All checks passed"
          
      - name: Check format
        run: |
          # Validate format: owner/repo, one per line
          while IFS= read -r line; do
            # Skip empty lines and comments
            [[ -z "$line" || "$line" =~ ^# ]] && continue
            
            # Check format
            if ! [[ "$line" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_.-]+$ ]]; then
              echo "❌ Invalid format: $line"
              echo "   Expected: owner/repo"
              exit 1
            fi
          done < registered.txt
          
          echo "✓ Format valid"
          
      - name: Check for duplicates
        run: |
          DUPES=$(grep -v '^#' registered.txt | grep -v '^$' | sort | uniq -d)
          if [ -n "$DUPES" ]; then
            echo "❌ Duplicate entries found:"
            echo "$DUPES"
            exit 1
          fi
          echo "✓ No duplicates"
